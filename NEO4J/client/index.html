<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Neo4j Dashboard | Clientes, Productos y Órdenes</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;600;700&display=swap');
    :root {
      --bg-1: #07120f;
      --bg-2: #0b1b16;
      --panel: rgba(14, 24, 20, 0.85);
      --border: #163328;
      --accent: #6bffb5;
      --accent-2: #5adba0;
      --text: #e8fff4;
      --muted: #9fb9ae;
      --input: #0d1814;
      --shadow: 0 15px 45px rgba(0,0,0,0.35);
      --radius: 14px;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      min-height: 100vh;
      font-family: 'Space Grotesk', 'Inter', system-ui, -apple-system, sans-serif;
      color: var(--text);
      background: radial-gradient(circle at 10% 20%, rgba(107,255,181,0.08), transparent 30%),
                  radial-gradient(circle at 80% 0%, rgba(72,230,160,0.1), transparent 35%),
                  linear-gradient(135deg, var(--bg-1), var(--bg-2));
      padding: 28px;
    }
    header {
      display: flex;
      align-items: center;
      flex-wrap: wrap;
      gap: 12px;
      margin-bottom: 18px;
    }
    .brand {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }
    .brand .kicker { font-size: 12px; letter-spacing: 0.1em; color: var(--muted); }
    h1 { margin: 0; letter-spacing: -0.02em; }
    .actions { display: flex; gap: 8px; flex-wrap: wrap; margin-left: auto; }
    button {
      border: 1px solid transparent;
      border-radius: 999px;
      padding: 9px 14px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      background: linear-gradient(135deg, var(--accent), var(--accent-2));
      color: #0b120f;
      box-shadow: var(--shadow);
    }
    button.secondary {
      background: transparent;
      color: var(--text);
      border-color: var(--border);
      box-shadow: none;
    }
    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 14px;
    }
    .card {
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 16px;
      box-shadow: var(--shadow);
    }
    h2 { margin: 0 0 4px; font-size: 20px; }
    .sub { margin: 0 0 12px; font-size: 13px; color: var(--muted); }
    label { display: block; margin-bottom: 6px; color: var(--muted); font-size: 13px; }
    input, select {
      width: 100%;
      padding: 11px;
      border-radius: 10px;
      border: 1px solid var(--border);
      background: var(--input);
      color: var(--text);
      font-size: 14px;
      margin-bottom: 10px;
      transition: border 0.2s ease, box-shadow 0.2s ease;
    }
    input:focus, select:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 2px rgba(107,255,181,0.15);
    }
    .row {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }
    .row > div { flex: 1 1 140px; }
    .tag { display: inline-block; padding: 4px 10px; border-radius: 999px; background: rgba(107,255,181,0.12); color: var(--accent); font-weight: 600; font-size: 12px; }
    pre {
      background: #0a1411;
      border: 1px solid var(--border);
      padding: 12px;
      border-radius: 12px;
      color: #cfe7db;
      overflow-x: auto;
      font-size: 12px;
      margin: 0;
      white-space: pre-wrap;
    }
    .status {
      padding: 10px 12px;
      border-radius: 10px;
      border: 1px solid var(--border);
      background: #0a1411;
      color: var(--muted);
      font-size: 13px;
    }
    .status.ok { color: var(--accent); border-color: rgba(107,255,181,0.4); }
    .status.error { color: #ff8fa3; border-color: rgba(255,143,163,0.3); }
    .pill {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 8px 12px;
      border-radius: 999px;
      background: rgba(107,255,181,0.08);
      border: 1px solid var(--border);
      color: var(--text);
      font-size: 13px;
    }
    .small { font-size: 12px; color: var(--muted); }
    .items-list { display: flex; flex-direction: column; gap: 6px; }
    .item-row {
      display: grid;
      grid-template-columns: 1.2fr 0.7fr 0.7fr auto;
      gap: 6px;
      align-items: end;
    }
    .item-row button { width: 100%; }
    @media (max-width: 768px) {
      body { padding: 18px; }
      .item-row { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>
  <header>
    <div class="brand">
      <span class="kicker">NEO4J + EXPRESS</span>
      <h1>Dashboard de Clientes, Productos y Órdenes</h1>
    </div>
    <div class="actions">
      <button class="secondary" id="btnRefresh">Refrescar datos</button>
      <button class="secondary" id="btnShowData">Ver datos</button>
      <button class="secondary" id="btnHealth">/health</button>
    </div>
  </header>

  <div class="row" style="margin-bottom:12px;">
    <div class="pill">
      <strong>API:</strong>
      <input id="baseUrl" style="width:220px; margin:0; background:transparent; border: none; color: var(--text); padding:0;" />
    </div>
    <div id="healthStatus" class="status" style="flex:1;">Sin probar</div>
  </div>

  <section class="grid">
    <div class="card">
      <h2>Clientes</h2>
      <p class="sub">Incluye género (Masculino/Femenino/Otro) y país.</p>
      <form id="formCliente">
        <label>ID</label>
        <input name="id" required placeholder="cliente-001" />
        <label>Nombre</label>
        <input name="nombre" placeholder="Ana López" />
        <label>Género</label>
        <select name="genero" required>
          <option value="">Selecciona</option>
          <option value="Masculino">Masculino</option>
          <option value="Femenino">Femenino</option>
          <option value="Otro">Otro</option>
        </select>
        <label>País</label>
        <input name="pais" placeholder="MX" />
        <button type="submit">Guardar cliente</button>
      </form>
      <p class="small" style="margin-top:6px;">Consulta los registros en el panel de datos.</p>
    </div>

    <div class="card">
      <h2>Productos</h2>
      <p class="sub">Permite equivalencias opcionales para SKU externos.</p>
      <form id="formProducto">
        <label>ID interno</label>
        <input name="id" required placeholder="prod-001" />
        <label>Nombre</label>
        <input name="nombre" placeholder="Laptop X" />
        <div class="row">
          <div>
            <label>Categoría</label>
            <input name="categoria" placeholder="Electrónica" />
          </div>
          <div>
            <label>SKU</label>
            <input name="sku" placeholder="SKU-123" />
          </div>
        </div>
        <div class="row">
          <div>
            <label>Código alterno</label>
            <input name="codigo_alt" placeholder="ALT-001" />
          </div>
          <div>
            <label>Código Mongo</label>
            <input name="codigo_mongo" placeholder="MONGO-001" />
          </div>
        </div>
        <button type="submit">Guardar producto</button>
      </form>
      <hr style="border: 0; border-top: 1px solid var(--border); margin: 12px 0;">
      <form id="formEquivalencia">
        <label>Crear equivalencia</label>
        <div class="row">
          <div>
            <label>Producto</label>
            <select name="id" id="equivProd"></select>
          </div>
          <div>
            <label>Equivalente</label>
            <select name="equivalenteId" id="equivProdTarget"></select>
          </div>
        </div>
        <button type="submit" class="secondary">Crear EQUIVALE_A</button>
      </form>
    </div>

    <div class="card">
      <h2>Órdenes (multi-moneda)</h2>
      <p class="sub">Debe usar clientes y productos existentes.</p>
      <form id="formOrden">
        <label>Cliente</label>
        <select name="clienteId" id="ordenCliente" required></select>
        <label>Canal</label>
        <select name="ordenCanal">
          <option value="">Selecciona</option>
          <option value="web">Web</option>
          <option value="app">App</option>
          <option value="tienda">Tienda</option>
          <option value="telefono">Teléfono</option>
        </select>
        <div class="row">
          <div>
            <label>ID Orden</label>
            <input name="ordenId" required placeholder="ord-1001" />
          </div>
          <div>
            <label>Fecha ISO</label>
            <input name="ordenFecha" placeholder="2024-11-01T10:00:00Z" />
          </div>
        </div>
        <div class="row">
          <div>
            <label>Moneda</label>
            <input name="ordenMoneda" placeholder="MXN" />
          </div>
          <div>
            <label>Total</label>
            <input name="ordenTotal" type="number" step="0.01" placeholder="0" />
          </div>
        </div>
        <div class="row">
          <div>
            <label>Producto</label>
            <select name="productoId" id="ordenProducto"></select>
          </div>
          <div>
            <label>Cantidad</label>
            <input name="cantidad" type="number" min="1" step="1" value="1" />
          </div>
          <div>
            <label>Precio unitario</label>
            <input name="precio_unit" type="number" step="0.01" value="0" />
          </div>
        </div>
        <button type="button" class="secondary" id="btnAddItem">Agregar item</button>
        <div id="itemsList" class="items-list" style="margin:10px 0;"></div>
        <div class="row" style="margin-top:4px;">
          <button type="submit">Crear orden</button>
          <button type="button" class="secondary" id="btnClearItems">Limpiar items</button>
        </div>
      </form>
    </div>
  </section>

  <section class="card" style="margin-top:14px;">
    <div class="row" style="align-items:center; margin-bottom:8px;">
      <h3 style="margin:0;">Panel de datos (clientes, productos, equivalencias, órdenes)</h3>
      <span class="small">Se alimenta con el botón “Refrescar datos”.</span>
    </div>
    <pre id="dataOut">[]</pre>
  </section>

  <script>
    const baseUrlInput = document.getElementById('baseUrl');
    const defaultBase = (window.location.origin || 'http://localhost:4000') + '/api';
    baseUrlInput.value = defaultBase;
    let baseUrl = defaultBase;

    const statusBox = document.getElementById('healthStatus');
    const itemsList = document.getElementById('itemsList');
    let items = [];

    const setStatus = (msg, type = '') => {
      statusBox.textContent = msg;
      statusBox.className = 'status ' + (type || '');
    };

    baseUrlInput.addEventListener('input', (e) => {
      baseUrl = e.target.value.trim();
    });

    const api = async (path, options = {}) => {
      const res = await fetch(baseUrl + path, {
        headers: { 'Content-Type': 'application/json' },
        ...options,
      });
      const data = await res.json().catch(() => ({}));
      if (!res.ok) {
        throw new Error(data.error || res.statusText);
      }
      return data;
    };

    document.getElementById('btnHealth').addEventListener('click', async () => {
      try {
        const res = await fetch((baseUrl.replace('/api','')) + '/health');
        const data = await res.json();
        setStatus('OK ' + JSON.stringify(data), 'ok');
      } catch (err) {
        setStatus('Error: ' + err.message, 'error');
      }
    });

    const clientesCache = [];
    const productosCache = [];

    const renderSelect = (select, data, labelKey = 'nombre') => {
      select.innerHTML = '';
      const opt = document.createElement('option');
      opt.value = '';
      opt.textContent = 'Selecciona';
      select.appendChild(opt);
      data.forEach((item) => {
        const o = document.createElement('option');
        o.value = item.id;
        o.textContent = item[labelKey] ? `${item[labelKey]} (${item.id})` : item.id;
        select.appendChild(o);
      });
    };

    const refreshData = async () => {
      try {
        const [clientes, productos] = await Promise.all([
          api('/clientes'),
          api('/productos')
        ]);
        clientesCache.splice(0, clientesCache.length, ...clientes);
        productosCache.splice(0, productosCache.length, ...productos.map(p => p.producto || p));
        renderSelect(document.getElementById('ordenCliente'), clientesCache);
        renderSelect(document.getElementById('ordenProducto'), productosCache);
        renderSelect(document.getElementById('equivProd'), productosCache);
        renderSelect(document.getElementById('equivProdTarget'), productosCache);
        document.getElementById('dataOut').textContent = JSON.stringify({
          clientes,
          productos,
        }, null, 2);
        setStatus('Datos refrescados', 'ok');
      } catch (err) {
        setStatus('Error refrescando: ' + err.message, 'error');
      }
    };

    document.getElementById('btnRefresh').addEventListener('click', refreshData);
    document.getElementById('btnShowData').addEventListener('click', () => {
      document.getElementById('dataOut').scrollIntoView({ behavior: 'smooth' });
    });

    // Clientes
    document.getElementById('formCliente').addEventListener('submit', async (e) => {
      e.preventDefault();
      const form = new FormData(e.target);
      const payload = Object.fromEntries(form.entries());
      try {
        await api('/clientes', { method: 'POST', body: JSON.stringify(payload) });
        setStatus('Cliente guardado', 'ok');
        refreshData();
        e.target.reset();
      } catch (err) {
        setStatus('Error cliente: ' + err.message, 'error');
      }
    });

    // Productos
    document.getElementById('formProducto').addEventListener('submit', async (e) => {
      e.preventDefault();
      const form = new FormData(e.target);
      const payload = Object.fromEntries(form.entries());
      try {
        await api('/productos', { method: 'POST', body: JSON.stringify(payload) });
        setStatus('Producto guardado', 'ok');
        refreshData();
        e.target.reset();
      } catch (err) {
        setStatus('Error producto: ' + err.message, 'error');
      }
    });

    // Equivalencias
    document.getElementById('formEquivalencia').addEventListener('submit', async (e) => {
      e.preventDefault();
      const form = new FormData(e.target);
      const id = form.get('id');
      const equivalenteId = form.get('equivalenteId');
      if (!id || !equivalenteId) {
        setStatus('Selecciona ambos productos', 'error');
        return;
      }
      try {
        await api(`/productos/${encodeURIComponent(id)}/equivalentes`, {
          method: 'POST',
          body: JSON.stringify({ equivalenteId }),
        });
        setStatus('Equivalencia creada', 'ok');
      } catch (err) {
        setStatus('Error equivalencia: ' + err.message, 'error');
      }
    });

    // Items UI
    const renderItems = () => {
      itemsList.innerHTML = '';
      if (!items.length) {
        const empty = document.createElement('div');
        empty.className = 'small';
        empty.textContent = 'Sin items agregados.';
        itemsList.appendChild(empty);
        return;
      }
      items.forEach((item, idx) => {
        const row = document.createElement('div');
        row.className = 'item-row';
        row.innerHTML = `
          <div class="pill"><strong>${item.productoId}</strong></div>
          <div class="pill">Cant: ${item.cantidad}</div>
          <div class="pill">Precio: ${item.precio_unit}</div>
          <button type="button" class="secondary" data-idx="${idx}">Quitar</button>
        `;
        row.querySelector('button').addEventListener('click', (ev) => {
          const i = Number(ev.target.dataset.idx);
          items.splice(i, 1);
          renderItems();
        });
        itemsList.appendChild(row);
      });
    };

    renderItems();

    document.getElementById('btnAddItem').addEventListener('click', () => {
      const form = document.getElementById('formOrden');
      const productoId = form.productoId.value;
      const cantidad = Number(form.cantidad.value || 0);
      const precio_unit = Number(form.precio_unit.value || 0);
      if (!productoId) {
        setStatus('Selecciona producto', 'error');
        return;
      }
      items.push({ productoId, cantidad, precio_unit });
      renderItems();
    });

    document.getElementById('btnClearItems').addEventListener('click', () => {
      items = [];
      renderItems();
    });

    // Orden
    document.getElementById('formOrden').addEventListener('submit', async (e) => {
      e.preventDefault();
      const form = new FormData(e.target);
      if (!items.length) {
        setStatus('Agrega al menos un item', 'error');
        return;
      }
      const payload = {
        cliente: { id: form.get('clienteId') },
        orden: {
          id: form.get('ordenId'),
          fecha: form.get('ordenFecha') || new Date().toISOString(),
          canal: form.get('ordenCanal') || null,
          moneda: form.get('ordenMoneda') || null,
          total: form.get('ordenTotal') ? Number(form.get('ordenTotal')) : null,
        },
        items,
      };
      try {
        const data = await api('/ordenes', { method: 'POST', body: JSON.stringify(payload) });
        setStatus('Orden creada', 'ok');
        document.getElementById('dataOut').textContent = JSON.stringify({ orden: data }, null, 2);
        items = [];
        renderItems();
        e.target.reset();
      } catch (err) {
        setStatus('Error orden: ' + err.message, 'error');
      }
    });

    // Load initial
    refreshData();
  </script>
</body>
</html>
